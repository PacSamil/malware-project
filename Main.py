"""
------------------------------------------
Created On : September 2020
Created By : Parv Chaudhary and Yash Pundir

Version:V1.04
------------------------------------------
"""
import requests
from bs4 import BeautifulSoup as bfs
import time
import pandas as pd
import datetime  
import re 
from tqdm import trange
import os 
#Ip Checker Main File
df = pd.read_excel(input_path,sheet_name=input_sheet)

def virus_total():
	headers = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'}
    for ip in trange(len(df.IP , desc='virustotal' , unit='IPs')):
        current_ip = df.loc[ip,'IP'].strip()
        try:
            url = f"https://www.virustotal.com/ui/ip_addresses/{current_ip}"
            raw = requests.get(url,headers=headers).json()                      #acccessing the response as json
            result_data = raw['data']['attributes']['last_analysis_stats']   #the data I need from the json
            total_checks = sum(result_data.values())
            wmalicious = result_data['malicious']
            
            # Actual result
            if wmalicious==0:
            	result = f"SAFE {wmalicious}/{total_checks}"
            elif 0<wmalicious<=3:
            	result = f"UNSAFE {wmalicious}/{total_checks}"
            else:
            	result = f"BLACKLISTED {wmalicious}/{total_checks}"
            df.loc[ip,'VIRUS TOTAL'] = result        
        except:
            df.loc[ip,'VIRUS TOTAL'] = "NA"
        time.sleep(8)

def ipvoid():
	url = "https://www.ipvoid.com/ip-blacklist-check/"
	session = requests.Session()
	for ip in trange(len(df.IP) , desc='Ipvoid' , unit='IPs'):
		current_ip = df.loc[ip,'IP'].strip()
		print(f"checking IP {df.loc[ip,'IP']} from ipvoid ({ip+1}/{df.shape[0]})")    # for checking purposes

		try:
		    pay_load = {"ip": current_ip}
		    request = session.post(url, data=pay_load)
		    soup = bfs(request.content, "lxml")

		    if len(soup.select('span.label.label-danger'))!=0:
		        wmalicious = soup.select('span.label.label-danger')[0].get_text()
		    elif len(soup.select('span.label.label-warning'))!=0:
		        wmalicious = soup.select('span.label.label-warning')[0].get_text()
		    else:
		        wmalicious = soup.select('span.label.label-success')[-1].get_text()
		    
		    # Actual result
		    nums = re.findall(r'\d+',wmalicious)
		    if int(nums[0])==0:
		    	result = f"SAFE {nums[0]}/{nums[1]}"
		    elif 0<int(nums[0])<=3:
		    	result = f"UNSAFE {nums[0]}/{nums[1]}"
		    else:
		    	result = f"BLACKLISTED {nums[0]}/{nums[1]}"

		    df.loc[ip,'IPVOID'] = result

		except:
			df.loc[ip,'IPVOID'] = 'NA'
		time.sleep(8)

def clear():
	try:
		os.system('cls')
	except :
		os.system('clear')

def initiate():
	print('''
		<><><><><><><><><><><
		      INITIATE
		<><><><><><><><><><><\n\n\n''')

	input_path = input('Enter the path of the input file:\n')
	input_sheet = input('\nName of the Sheet in Excel file where the IP addresses are stored:\n')
	output_path = input('\nEnter path for where to save the file:\n')
	clear()

def configure():
	print('''
		<><><><><><><><><><><
		     CONFIGURING
		<><><><><><><><><><><\n\n\n''')
	start_time=time.time()
	print("Ipvoid Starting ")
	ipvoid()
	print("Virustotal Starting")
	virus_total()
	clear()
	elapsed_time=time.time() - start_time

def terminate():
	print('''
		<><><><><><><><><><><
		      Thankyou
		<><><><><><><><><><><\n\n\n''')

	print("Program has sucessfully completed , Please Check your file " + str(output_path) )
	time.sleep(500)

def save_results():
	writer = pd.ExcelWriter(output_path)
	df.to_excel(writer)
	writer.save()
	with open('log.txt','a') as file:
	    file.write(f"""--------------------------\nScript execution : SUCCESS\nDATE : {log.date()}\nTIME : {log.time()}\nElapsed/Execution Time : {elapsed_time}\nTotal IPs checked : {len(df.IP)}\n--------------------------\n\n""")

try:
	initiate()
	configure()
	save_results()
	terminate()
except:
	with open('log.txt','a') as file:
	   file.write(f"""--------------------------\nScript execution : FAILED\nDATE : {log.date()}\nTIME : {log.time()}\nElapsed/Execution Time : {elapsed_time}\nTotal IPs checked : {len(df.IP)}\n--------------------------\n\n"""